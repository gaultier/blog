<!DOCTYPE html>
<html>
<head>
<title>Learn Wayland by writing a GUI from scratch</title>
<meta charset="utf-8">
<link rel="shortcut icon" type="image/ico" href="/blog/favicon.ico"/>
<link rel="stylesheet" type="text/css" href="main.css">
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.8.0/styles/default.min.css">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.8.0/highlight.min.js"></script>
<script>
window.addEventListener("load", (event) => {
  hljs.highlightAll();
});
</script>
</head>
<body>

<div id="banner">
    <a id="name" href="/blog"><img id="me" src="me.jpeg"/> Philippe Gaultier </a>
    <ul>
      <li>
      <a href="/blog/body_of_work.html">Body of work</a>
      </li>
      <li>
        <a href="https://github.com/gaultier/resume/raw/master/Philippe_Gaultier_resume_en.pdf">Resume</a>
      </li>
      <li>
      <a href="https://www.linkedin.com/in/philippegaultier/">LinkedIn</a>
      </li>
      <li>
        <a href="https://github.com/gaultier">Github</a>
      </li>
      <li>
      <a href="/blog/feed.xml">Feed</a>
      </li>
    </ul>
</div>
<div class="body">

<p id="publication_date">Published on 2023-10-12.</p>
<h1 id="learn-wayland-by-writing-a-gui-from-scratch">Learn Wayland by
writing a GUI from scratch</h1>
<p><a href="https://wayland.freedesktop.org/">Wayland</a> is all the
rage those days. Distributions left and right switch to it, many readers
of my previous article on <a href="/blog/x11_x64.html">writing a X11 GUI
from scratch in x86_64 assembly</a> asked for a follow-up article about
Wayland, and I now run Wayland on my desktop. So here we go, let’s write
a (very simple) GUI program with Wayland, without any libraries, this
time in C.</p>
<p>Here is what we are working towards:</p>
<figure>
<img src="wayland-screenshot-tiled1.png" alt="Result" />
<figcaption aria-hidden="true">Result</figcaption>
</figure>
<p>We display the Wayland logo in its own window (we can see the
mountain wallpaper in the background since we use a fixed size buffer).
It’s not quite Visual Studio yet, I know, but it’s a good foundation for
more in future articles, perhaps.</p>
<p>Why not in assembly again you ask? Well, the Wayland protocol has
some peculiarities that necessitate the use of some C standard library
macros to make it work reliably on different platforms (Linux, FreeBSD,
etc): namely, sending a file descriptor over a UNIX socket. Maybe it
could be done in assembly, but it would be much more tedious. Also, the
Wayland protocol is completely asynchronous by nature, whereas the X11
protocol was more of a request-(maybe) response chatter, and as such, we
have to keep track of some state in our program, and C makes it
easier.</p>
<p>Now, if you want to follow along and translate the C snippets into
assembly, go for it, it is doable, just tedious.</p>
<blockquote>
<p>If you spot an error, please open a <a
href="https://github.com/gaultier/blog">Github issue</a>!</p>
</blockquote>
<p><em>This article has been discussed on <a
href="https://news.ycombinator.com/item?id=37876896">Hacker News</a> and
<a
href="https://lobste.rs/s/385e2w/learn_wayland_by_writing_gui_from_scratch">Lobsters</a>.</em></p>
<p><strong>Table of Contents</strong></p>
<ul>
<li><a href="#what-do-we-need">What do we need?</a></li>
<li><a href="#wayland-basics">Wayland basics</a></li>
<li><a href="#opening-a-socket">Opening a socket</a></li>
<li><a href="#creating-a-registry">Creating a registry</a></li>
<li><a href="#shared-memory-the-frame-buffer">Shared memory: the frame
buffer</a></li>
<li><a href="#chatting-with-the-compositor">Chatting with the
compositor</a>
<ul>
<li><a href="#reacting-to-events-binding-interfaces">Reacting to events:
binding interfaces</a></li>
<li><a href="#using-the-interfaces-we-created">Using the interfaces we
created</a></li>
<li><a href="#reacting-to-events-pingpong">Reacting to events:
ping/pong</a></li>
<li><a href="#reacting-to-events-configureack-configure">Reacting to
events: configure/ACK configure</a></li>
<li><a href="#rendering-a-frame-the-red-rectangle">Rendering a frame:
the red rectangle</a></li>
<li><a href="#rendering-a-frame-the-wayland-logo">Rendering a frame: The
Wayland logo</a></li>
</ul></li>
<li><a href="#the-end">The end</a></li>
<li><a href="#addendum-the-full-code">Addendum: the full code</a></li>
</ul>
<h2 id="what-do-we-need">What do we need?</h2>
<p>Not much: We’ll use C99 so any C compiler of the last 20 years will
do. Having a Wayland desktop to test the application will also greatly
help.</p>
<p>Note that I have only run it on Linux; it should work (meaning:
compile and run) on other platforms running Wayland such as FreeBSD,
it’s just that I have not tried.</p>
<p><em>Note that the code in this article has not been written in the
most robust way, it simply exits when things are not how they should be
for example. So, not production ready, but still a good learning
resource and a good foundation for more.</em></p>
<h2 id="wayland-basics">Wayland basics</h2>
<p>Wayland is a protocol specification for GUI applications (and more),
in short. We will write the client side, while the server side is a
compositor which understands our protocol. If you have a Wayland desktop
right now, a Wayland compositor is already running so there is nothing
to do.</p>
<p>Much like X11, a client opens a UNIX socket, sends some commands in a
specific format (which are different from the X11 ones), to open a
window and the server can also send messages to notify the client to
resize the window, that there is some keyboard input, etc. It’s
important to note that contrary to X11, in Wayland, the client only has
access to its own window.</p>
<p>It is also interesting to note that Wayland is quite a limited
protocol and any GUI will have to use extension protocols.</p>
<p>Most client applications use <code>libwayland</code> which is a
library composed of C files that are autogenerated from a XML file
describing the protocol. The same goes for extension protocols: they
simply are one XML file that is turned into C files, which are then
compiled and linked to a GUI application.</p>
<p>Now, we will not do any of this: we will instead write our own
serialization and deserialization functions, which is really not a lot
of work as you will see.</p>
<p>There are many advantages:</p>
<ul>
<li>No need to link to external libraries: no build system complexities,
no dynamic linking issues, and so on.</li>
<li>We do not have to use the callback system that
<code>libwayland</code> requires.</li>
<li>We can use the I/O mechanism we wish to listen to incoming messages:
blocking, <code>poll</code>, <code>select</code>, <code>epoll</code>,
<code>io_uring</code>, <code>kqueue</code> on some systems, etc. Here,
we will use blocking calls for simplicity but the world is your
oyster.</li>
<li>Easy troubleshooting: 100% of the code is our own.</li>
<li>No XML</li>
<li>The protocols we will use are stable so the numeric values on the
wire should not change underneath us, but in the unlikely event they do,
we simply have to fix them in our code and compile again.</li>
</ul>
<p>So at this point you might be thinking: this is going to be so much
work! Well, not really. Here are <strong>all</strong> of the Wayland
protocol numeric values we will need, including the extension
protocols:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_display_object_id <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_registry_event_global <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_shm_pool_event_format <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_buffer_event_release <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_event_ping <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_toplevel_event_configure <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_toplevel_event_close <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_event_configure <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_display_get_registry_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_registry_bind_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_compositor_create_surface_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_pong_opcode <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_ack_configure_opcode <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_shm_create_pool_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_get_xdg_surface_opcode <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_shm_pool_create_buffer_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_surface_attach_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_get_toplevel_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_surface_commit_opcode <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_display_error_event <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_format_xrgb8888 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_header_size <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> color_channels <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span></code></pre></div>
<p>So, not that much!</p>
<h2 id="opening-a-socket">Opening a socket</h2>
<p>The first step is opening a UNIX domain socket. Note that this step
is exactly the same as for X11, save for the path of the socket. Also,
X11 is designed to be used over the network so it does not have to be a
UNIX domain socket, on the same machine - but everybody does so on their
desktop machine anyway.</p>
<p>To craft the socket path, we follow these simple steps:</p>
<ul>
<li>If <code>$WAYLAND_DISPLAY</code> is set, attempt to connect to
<code>$XDG_RUNTIME_DIR/$WAYLAND_DISPLAY</code></li>
<li>Otherwise, attempt to connect to
<code>$XDG_RUNTIME_DIR/wayland-0</code></li>
<li>Otherwise, fail</li>
</ul>
<p>Here goes, along with two utility macros we’ll use everywhere:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define cstring_len(s) (sizeof(s) - 1)</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define roundup_4(n) (((n) + 3) &amp; -4)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> wayland_display_connect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>xdg_runtime_dir <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;XDG_RUNTIME_DIR&quot;</span><span class="op">);</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>xdg_runtime_dir <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EINVAL<span class="op">;</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> xdg_runtime_dir_len <span class="op">=</span> strlen<span class="op">(</span>xdg_runtime_dir<span class="op">);</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> sockaddr_un addr <span class="op">=</span> <span class="op">{.</span>sun_family <span class="op">=</span> AF_UNIX<span class="op">};</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>xdg_runtime_dir_len <span class="op">&lt;=</span> cstring_len<span class="op">(</span>addr<span class="op">.</span>sun_path<span class="op">));</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> socket_path_len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path<span class="op">,</span> xdg_runtime_dir<span class="op">,</span> xdg_runtime_dir_len<span class="op">);</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  socket_path_len <span class="op">+=</span> xdg_runtime_dir_len<span class="op">;</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  addr<span class="op">.</span>sun_path<span class="op">[</span>socket_path_len<span class="op">++]</span> <span class="op">=</span> <span class="ch">&#39;/&#39;</span><span class="op">;</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>wayland_display <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;WAYLAND_DISPLAY&quot;</span><span class="op">);</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>wayland_display <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wayland_display_default<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wayland-0&quot;</span><span class="op">;</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> wayland_display_default_len <span class="op">=</span> cstring_len<span class="op">(</span>wayland_display_default<span class="op">);</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path <span class="op">+</span> socket_path_len<span class="op">,</span> wayland_display_default<span class="op">,</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>           wayland_display_default_len<span class="op">);</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>    socket_path_len <span class="op">+=</span> wayland_display_default_len<span class="op">;</span></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> wayland_display_len <span class="op">=</span> strlen<span class="op">(</span>wayland_display<span class="op">);</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path <span class="op">+</span> socket_path_len<span class="op">,</span> wayland_display<span class="op">,</span></span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a>           wayland_display_len<span class="op">);</span></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a>    socket_path_len <span class="op">+=</span> wayland_display_len<span class="op">;</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> fd <span class="op">=</span> socket<span class="op">(</span>AF_UNIX<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>connect<span class="op">(</span>fd<span class="op">,</span> <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>addr<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>addr<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> fd<span class="op">;</span></span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>In Wayland, there is no connection setup to do, such as sending some
special messages, so there is nothing more to do.</p>
<h2 id="creating-a-registry">Creating a registry</h2>
<p>Now, to do anything useful, we want to create a registry: it is an
object that allows us to query at runtime the capabilities of the
compositor.</p>
<p>In Wayland, to create an object, we simply send the right message
followed by an id of our own. Ids should be unique so we simply
increment a number each time we want to create a new resource. After
this is done, we will remember this number to be able to refer to it in
later messages:</p>
<p>This is coincidentally our first message we send, so let’s briefly go
over the structure of a Wayland message. It is basically a RPC
mechanism. All bytes are in the host endianness so there is nothing
special to do about it:</p>
<ul>
<li>4 bytes: The id of the resource (‘object’) we want to call a method
on</li>
<li>2 bytes: The opcode of the method we want to call</li>
<li>2 bytes: The size of the message</li>
<li>Depending on the method, arguments in their wire format follow</li>
</ul>
<p>The object id in this case is <code>1</code>, which is the singleton
<code>wl_display</code> that already exists. The method is:
<code>get_registry(u32 new_id)</code> whose opcode we listed before. The
sole argument takes 4 bytes and is this incremental number we keep track
of client-side. It does not necessarily have to be incremental, but
that’s what <code>libwayland</code> does and also it’s the easiest.</p>
<p>For convenience and efficiency, we always craft the message on the
stack and do not allocate dynamic memory.</p>
<p>We first introduce a few utility functions to read and write parts of
messages:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_u32<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">uint32_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(((</span><span class="dt">size_t</span><span class="op">)</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(</span><span class="dt">uint32_t</span> <span class="op">*)(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">);</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_u16<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">uint16_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(((</span><span class="dt">size_t</span><span class="op">)</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(</span><span class="dt">uint16_t</span> <span class="op">*)(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">);</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_string<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">char</span> <span class="op">*</span>src<span class="op">,</span> <span class="dt">uint32_t</span> src_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> src_len <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>buf<span class="op">,</span> buf_size<span class="op">,</span> buf_cap<span class="op">,</span> src_len<span class="op">);</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">,</span> src<span class="op">,</span> roundup_4<span class="op">(</span>src_len<span class="op">));</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> roundup_4<span class="op">(</span>src_len<span class="op">);</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> buf_read_u32<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">));</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">((</span><span class="dt">size_t</span><span class="op">)*</span>buf <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> res <span class="op">=</span> <span class="op">*(</span><span class="dt">uint32_t</span> <span class="op">*)(*</span>buf<span class="op">);</span></span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint16_t</span> buf_read_u16<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint16_t</span><span class="op">));</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">((</span><span class="dt">size_t</span><span class="op">)*</span>buf <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint16_t</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> res <span class="op">=</span> <span class="op">*(</span><span class="dt">uint16_t</span> <span class="op">*)(*</span>buf<span class="op">);</span></span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_read_n<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>dst<span class="op">,</span> <span class="dt">uint64_t</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> n<span class="op">);</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>dst<span class="op">,</span> <span class="op">*</span>buf<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> n<span class="op">;</span></span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> n<span class="op">;</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And we finally can send our first message:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_display_get_registry<span class="op">(</span><span class="dt">int</span> fd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_display_object_id<span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>                wayland_wl_display_get_registry_opcode<span class="op">);</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">);</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> MSG_DONTWAIT<span class="op">))</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_display@%u.get_registry: wl_registry=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>         wayland_display_object_id<span class="op">,</span> wayland_current_id<span class="op">);</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>And by calling it, we have created our very first Wayland
resource!</p>
<p><em>From this point on, the utility functions to send Wayland
messages (<code>wayland_*</code>) will not be included in the code
snippets for brevity (but you will find all of the code at the end!),
just because they all are similar to the one above.</em></p>
<h2 id="shared-memory-the-frame-buffer">Shared memory: the frame
buffer</h2>
<p>To avoid drawing a frame in our application, and having to send all
of the bytes over the socket to the compositor, there is a smarter
approach: the buffer should be shared between the two processes, so that
no copying is required.</p>
<p>We need to synchronize the access between the two so that presenting
the frame does not happen while we are still drawing it, and Wayland has
us covered here.</p>
<p>First, we need to create this buffer. We are going to make it easier
for us by using a fixed size. Wayland is going to send us ‘resize’
events, whenever the window size changes, which we will acknowledge and
ignore. This is done here just to simplify a bit the article, obviously
in a real application, you would resize the buffer.</p>
<p>First, we introduce a struct that will hold all of the client-side
state so that we remember which resources we have created so far. We
also need a super simple state machine for later to track whether the
surface (i.e. the ‘frame’ data) should be drawn to, as mentioned:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> state_state_t state_state_t<span class="op">;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> state_state_t <span class="op">{</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  STATE_NONE<span class="op">,</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  STATE_SURFACE_ACKED_CONFIGURE<span class="op">,</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  STATE_SURFACE_ATTACHED<span class="op">,</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> state_t state_t<span class="op">;</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> state_t <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_registry<span class="op">;</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_shm<span class="op">;</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_shm_pool<span class="op">;</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_buffer<span class="op">;</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_wm_base<span class="op">;</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_surface<span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_compositor<span class="op">;</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_surface<span class="op">;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_toplevel<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stride<span class="op">;</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> w<span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> h<span class="op">;</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> shm_pool_size<span class="op">;</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> shm_fd<span class="op">;</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> <span class="op">*</span>shm_pool_data<span class="op">;</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>  state_state_t state<span class="op">;</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>We use it so in <code>main()</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>  state_t state <span class="op">=</span> <span class="op">{</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>wl_registry <span class="op">=</span> wayland_wl_display_get_registry<span class="op">(</span>fd<span class="op">),</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>w <span class="op">=</span> <span class="dv">117</span><span class="op">,</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>h <span class="op">=</span> <span class="dv">150</span><span class="op">,</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>stride <span class="op">=</span> <span class="dv">117</span> <span class="op">*</span> color_channels<span class="op">,</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Single buffering.</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  state<span class="op">.</span>shm_pool_size <span class="op">=</span> state<span class="op">.</span>h <span class="op">*</span> state<span class="op">.</span>stride<span class="op">;</span></span></code></pre></div>
<p>The window is a rectangle, of width <code>w</code> and height
<code>h</code>. We will use the color format <code>xrgb8888</code> which
is 4 color channels, each taking one bytes, so 4 bytes per pixel. This
is one of the two formats that is guaranteed to be supported by the
compositor per the specification. The stride counts how many bytes a
horizontal row takes: <code>w * 4</code>.</p>
<p>And so, our buffer size for the frame is : <code>w * h * 4</code>. We
use single buffering again for simplicity and also because we want to
display a static image.</p>
<p>We could choose to use double or even triple buffering, thus
respectively doubling or tripling the buffer size. The compositor is
none the wiser - we would simply keep a counter client-side that
increments each time we render a frame (and wraps around back to 0 when
reaching the number of buffers), we would draw in the right location of
this big buffer (i.e. at an offset), and attach the right part of the
buffer to the surface. All the Wayland calls would remain the same.</p>
<p>Alright, time to really create this buffer, and not only keep track
of its size:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> create_shared_memory_file<span class="op">(</span><span class="dt">uint64_t</span> size<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> name<span class="op">[</span><span class="dv">255</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">uint64_t</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> cstring_len<span class="op">(</span>name<span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>    name<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">((</span><span class="dt">double</span><span class="op">)</span>rand<span class="op">())</span> <span class="op">/</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>RAND_MAX <span class="op">*</span> <span class="dv">26</span> <span class="op">+</span> <span class="ch">&#39;a&#39;</span><span class="op">;</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> fd <span class="op">=</span> shm_open<span class="op">(</span>name<span class="op">,</span> O_RDWR <span class="op">|</span> O_EXCL <span class="op">|</span> O_CREAT<span class="op">,</span> <span class="bn">0600</span><span class="op">);</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>shm_unlink<span class="op">(</span>name<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>ftruncate<span class="op">(</span>fd<span class="op">,</span> size<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  state<span class="op">-&gt;</span>shm_pool_data <span class="op">=</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>      mmap<span class="op">(</span>NULL<span class="op">,</span> size<span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">,</span> MAP_SHARED<span class="op">,</span> fd<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>shm_pool_data <span class="op">!=</span> NULL<span class="op">);</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>  state<span class="op">-&gt;</span>shm_fd <span class="op">=</span> fd<span class="op">;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>We use <code>shm_open(3)</code> to create a POSIX shared memory
object, so that we later can send the corresponding file descriptor to
the compositor so that the latter also has access to it. The flags
mean:</p>
<ul>
<li><code>O_RDWR</code>: Read-write.</li>
<li><code>O_CREAT</code>: If the file does not exist, create it.</li>
<li><code>O_EXCL</code>: Return an error if the shared memory object
with this name already exists (we do not want that another running
instance of the application gets by mistake the same memory
buffer).</li>
</ul>
<p>We alternatively could use <code>memfd_create(2)</code> which spares
us from crafting a unique path but this is Linux specific.</p>
<p>We craft a unique, random path to avoid clashes with other running
applications.</p>
<p>Right after, we remove the file on the filesystem with
<code>shm_unlink</code> to not leave any traces when the program
finishes. Note that the file descriptor remains valid since our process
still has the file open (there is a reference counting mechanism in the
kernel behind the scenes).</p>
<p>We then resize with <code>ftruncate</code> and memory map this file
with <code>mmap(2)</code>, effectively allocating memory, with the
<code>MAP_SHARED</code> flag to allow the compositor to also read this
memory.</p>
<p>Later, we will send the file descriptor over the UNIX domain socket
as ancillary data to the compositor.</p>
<p>Alright, we now have some memory to draw our frame to, but the
compositor does not know of it yet. Let’s tackle that now.</p>
<h2 id="chatting-with-the-compositor">Chatting with the compositor</h2>
<p>We are going to exchange messages back and forth over the socket with
the compositor. Let’s use plain old blocking calls in <code>main</code>
like it’s the 70’s. We read as much as we can from the socket:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> read_buf<span class="op">[</span><span class="dv">4096</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> read_bytes <span class="op">=</span> recv<span class="op">(</span>fd<span class="op">,</span> read_buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>read_buf<span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>read_bytes <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>msg <span class="op">=</span> read_buf<span class="op">;</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> msg_len <span class="op">=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span>read_bytes<span class="op">;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>msg_len <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>      wayland_handle_message<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_len<span class="op">);</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>The read buffer very likely now contains a sequence of various
messages, which we parse and handle with
<code>wayland_handle_message</code> eagerly until the end of the buffer.
This might break if a message is spanning two different read buffers - a
ring buffer would be more appropriate to handle this case gracefully,
but again, for this article this is fine.</p>
<p><code>wayland_handle_message</code> reads the header part of every
message as described in the beginning, and reacts to known opcodes and
objects:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_handle_message<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>msg<span class="op">,</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">uint64_t</span> <span class="op">*</span>msg_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>msg_len <span class="op">&gt;=</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> object_id <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>object_id <span class="op">&lt;=</span> wayland_current_id<span class="op">);</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> opcode <span class="op">=</span> buf_read_u16<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> announced_size <span class="op">=</span> buf_read_u16<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>announced_size<span class="op">)</span> <span class="op">&lt;=</span> announced_size<span class="op">);</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> header_size <span class="op">=</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>      <span class="kw">sizeof</span><span class="op">(</span>object_id<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>opcode<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>announced_size<span class="op">);</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>announced_size <span class="op">&lt;=</span> header_size <span class="op">+</span> <span class="op">*</span>msg_len<span class="op">);</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>wl_registry <span class="op">&amp;&amp;</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>      opcode <span class="op">==</span> wayland_wl_registry_event_global<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>      <span class="co">// </span><span class="al">TODO</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Following: Lots of `if (opcode == ...) {... } else if (opcode = ...) { ... } [...]`</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="reacting-to-events-binding-interfaces">Reacting to events:
binding interfaces</h3>
<p>At this point we have sent one message to the compositor:
<code>wl_display@1.get_registry()</code> thanks to our C function
<code>wayland_wl_display_get_registry</code>. The compositor responds
with a series of events, listing the available global objects, such as
shared memory support, extension protocols, etc.</p>
<p>Each event contains the interface name, which is a string. Now, in
the Wayland protocol, the string length gets padded to a multiple of
four, so we have read those padding bytes as well.</p>
<p>If we see a global object that we are interested in, we create one of
this type, and record the new id in our <code>state</code> structure for
later use. While we’re at it, we also handle error events. If the
compositor does not like our messages, it will complain with some useful
error messages in there:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>wl_registry <span class="op">&amp;&amp;</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>      opcode <span class="op">==</span> wayland_wl_registry_event_global<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> name <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> interface_len <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> padded_interface_len <span class="op">=</span> roundup_4<span class="op">(</span>interface_len<span class="op">);</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> interface<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>padded_interface_len <span class="op">&lt;=</span> cstring_len<span class="op">(</span>interface<span class="op">));</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    buf_read_n<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">,</span> interface<span class="op">,</span> padded_interface_len<span class="op">);</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>interface<span class="op">[</span>interface_len<span class="op">]</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> version <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- wl_registry@%u.global: name=%u interface=%.*s version=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>           state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface_len<span class="op">,</span> interface<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>announced_size <span class="op">==</span> <span class="kw">sizeof</span><span class="op">(</span>object_id<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>announced_size<span class="op">)</span> <span class="op">+</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>opcode<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>name<span class="op">)</span> <span class="op">+</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>interface_len<span class="op">)</span> <span class="op">+</span> padded_interface_len <span class="op">+</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>version<span class="op">));</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wl_shm_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wl_shm&quot;</span><span class="op">;</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>wl_shm_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>wl_shm <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> xdg_wm_base_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;xdg_wm_base&quot;</span><span class="op">;</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>xdg_wm_base_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>xdg_wm_base <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wl_compositor_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wl_compositor&quot;</span><span class="op">;</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>wl_compositor_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>wl_compositor <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> wayland_display_object_id <span class="op">&amp;&amp;</span> opcode <span class="op">==</span> wayland_wl_display_error_event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> target_object_id <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> code <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> error<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> error_len <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>    buf_read_n<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">,</span> error<span class="op">,</span> roundup_4<span class="op">(</span>error_len<span class="op">));</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;fatal error: target_object_id=%u code=%u error=%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            target_object_id<span class="op">,</span> code<span class="op">,</span> error<span class="op">);</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EINVAL<span class="op">);</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<p>Remember: Since the Wayland protocol is a kind of RPC, we need to
create the objects first before calling remote methods on them.</p>
<p>In terms of robustness, we do not have guarantees that every feature
(i.e.: interface) we need in our application will be supported by the
compositor. It could be a good idea to bail if the interfaces we require
are not present.</p>
<h3 id="using-the-interfaces-we-created">Using the interfaces we
created</h3>
<p>We can now call methods on the new interfaces to create more entities
we will need, namely:</p>
<ul>
<li>A <code>wl_surface</code></li>
<li>A <code>xdg_surface</code></li>
<li>A <code>xdg_toplevel</code></li>
</ul>
<p>The last two being entities from extension protocols, which is
inconsequential in our implementation since we do not link against any
libraries. This is just the same logic as the other messages and events
from the core protocol.</p>
<p>Once we have done that, the surface is setup, and we commit it, to
signal to the compositor to atomically apply the changes to the
surface.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>msg_len <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>      wayland_handle_message<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_len<span class="op">);</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_compositor <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> state<span class="op">.</span>wl_shm <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>xdg_wm_base <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_surface <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">// Bind phase complete, need to create surface.</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>state <span class="op">==</span> STATE_NONE<span class="op">);</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>wl_surface <span class="op">=</span> wayland_wl_compositor_create_surface<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>xdg_surface <span class="op">=</span> wayland_xdg_wm_base_get_xdg_surface<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>xdg_toplevel <span class="op">=</span> wayland_xdg_surface_get_toplevel<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_commit<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<h3 id="reacting-to-events-pingpong">Reacting to events: ping/pong</h3>
<p>For some entities, the Wayland compositor will send us a ping message
and expect a pong back to ensure our application is responsive and not
deadlocked or frozen.</p>
<p>We just have to add one more <code>if</code> to the long list of
<code>if</code>s to handle each event from the compositor:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_wm_base <span class="op">&amp;&amp;</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_wm_base_event_ping<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ping <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_wm_base@%u.ping: ping=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_wm_base<span class="op">,</span> ping<span class="op">);</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    wayland_xdg_wm_base_pong<span class="op">(</span>fd<span class="op">,</span> state<span class="op">,</span> ping<span class="op">);</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span></code></pre></div>
<h3 id="reacting-to-events-configureack-configure">Reacting to events:
configure/ACK configure</h3>
<p>Akin to the previous ping/pong mechanism, we receive a
<code>configure</code> event for the <code>xdg_surface</code> and we
reply with a <code>ack_configure</code> message.</p>
<p>This is an important milestone since from that point on, we can start
rendering our frame! We thus advance our little state machine:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_surface <span class="op">&amp;&amp;</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_surface_event_configure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> configure <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_surface@%u.configure: configure=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_surface<span class="op">,</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>           configure<span class="op">);</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    wayland_xdg_surface_ack_configure<span class="op">(</span>fd<span class="op">,</span> state<span class="op">,</span> configure<span class="op">);</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>state <span class="op">=</span> STATE_SURFACE_ACKED_CONFIGURE<span class="op">;</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> </span></code></pre></div>
<h3 id="rendering-a-frame-the-red-rectangle">Rendering a frame: the red
rectangle</h3>
<p>Once the configure/ack configure step has been completed, we can
render a frame.</p>
<p>To do so, we need to create two final entities: a shared memory pool
(<code>wl_shm_pool</code>) and a <code>wl_buffer</code> if they do not
exist yet.</p>
<p>Finally, we fiddle with the pixel data anyway we want, remembering
the color format we picked (XRGB8888), attach the buffer to the surface,
and commit the surface.</p>
<p>This acts as synchronization mechanism between the client and the
compositor to avoid presenting a half-rendered frame. To sum up:</p>
<ol type="1">
<li>The <code>ack_configure</code> event signals us that we can start
rendering the frame</li>
<li>We render the frame client-side by setting the pixel data to
whatever we want</li>
<li>We send the <code>attach</code> + <code>commit</code> messages to
notify the compositor that the frame is ready to be presented</li>
<li>We advance our state machine to avoid writing to the frame data
while the compositor is presenting it</li>
</ol>
<p>So let’s show a red rectangle as a warm-up. The alpha component is
completely ignored as far as I can tell in this color format:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>state <span class="op">==</span> STATE_SURFACE_ACKED_CONFIGURE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render a frame.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>wl_surface <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>xdg_surface <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>xdg_toplevel <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_shm_pool <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_shm_pool <span class="op">=</span> wayland_wl_shm_create_pool<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_buffer <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_buffer <span class="op">=</span> wayland_wl_shm_pool_create_buffer<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>shm_pool_data <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>shm_pool_size <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint32_t</span> <span class="op">*</span>pixels <span class="op">=</span> <span class="op">(</span><span class="dt">uint32_t</span> <span class="op">*)</span>state<span class="op">.</span>shm_pool_data<span class="op">;</span></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">uint32_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> state<span class="op">.</span>w <span class="op">*</span> state<span class="op">.</span>h<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> r <span class="op">=</span> <span class="bn">0xff</span><span class="op">;</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> g <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> b <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a>        pixels<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>r <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span>g <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">|</span> b<span class="op">;</span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_attach<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_commit<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>state <span class="op">=</span> STATE_SURFACE_ATTACHED<span class="op">;</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span></code></pre></div>
<p>Result:</p>
<figure>
<img src="wayland-screenshot-red.png" alt="Result, red" />
<figcaption aria-hidden="true">Result, red</figcaption>
</figure>
<h3 id="rendering-a-frame-the-wayland-logo">Rendering a frame: The
Wayland logo</h3>
<p>Let’s render something more interesting. We download the <a
href="https://wayland.freedesktop.org/wayland.png">Wayland logo</a>, but
we do not want to have to deal with a complicated format like PNG
(because we then have to uncompress the image data with
<code>zlib</code> or similar).</p>
<p>We thus convert it offline to a simpler image format, PPM6, and then
embed the raw pixel data in our code as an byte array, skipping over the
first 15 bytes which are metadata:</p>
<pre class="shell"><code>$ file wayland.png
wayland.png: PNG image data, 117 x 150, 8-bit/color RGBA, non-interlaced
$ convert wayland.png wayland.ppm
$ file wayland.ppm
wayland.ppm: Netpbm image data, size = 117 x 150, rawbits, pixmap
$ xxd -s +15 -i wayland.ppm  &gt; wayland-logo.h
$ sed -i &#39;s/wayland_ppm/wayland_logo/g&#39; wayland-logo.h</code></pre>
<p><em>The resulting C array created by <code>xxd</code> will be named
after the input file i.e. <code>wayland_ppm</code>. We rename it with
the last command to something more human-readable.</em></p>
<p>The image is now in the <code>RGB</code> format (3 bytes per pixel),
which we have to convert to the <code>XRGB</code> format (4 bytes per
pixel). Our frame rendering loop becomes:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;wayland-logo.h&quot;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="op">[...]</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">uint32_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> state<span class="op">.</span>w <span class="op">*</span> state<span class="op">.</span>h<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> r <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">0</span><span class="op">];</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> g <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> b <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">];</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>        pixels<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>r <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span>g <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">|</span> b<span class="op">;</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span></code></pre></div>
<p>And finally we see the result.</p>
<p>Tiled: <img src="wayland-screenshot-tiled1.png"
alt="Result, tiled" /></p>
<p>Floating: <img src="wayland-screenshot-floating.png"
alt="Result, floating" /></p>
<p><em>Note: We handle the absolute minimum set of events coming from
the compositor to make it work in a simple way. If your particular
compositor sends more events, they will have to be read (and possibly
ignored). Since the Wayland protocol uses a Tag-Length-Value (TLV)
encoding, one can simply skip over <code>&lt;length&gt;</code> bytes if
the opcode is unknown. But some events will demand a reply
(e.g. ping/pong)!</em></p>
<h2 id="the-end">The end</h2>
<p>It was not that much work to go from zero to a working GUI
application, albeit a simplistic one.</p>
<p>Compared to X11, it was a bit more work, but not that much. The
barrier of entry is higher but the concepts and architecture are more
sound, it seems to me.</p>
<p>The setup is a bit tedious but once this is done, we are in practice
going to spend all of our time in the frame rendering code, and perhaps
add support for a few additional events (we do not yet support keyboard
or mouse events, for example, or animations, which would require us to
notify the compositor that a region was ‘damaged’ meaning modified, and
needs re-rendering).</p>
<p>Thus, I have the feeling that Wayland really goes out of the way once
the initial scaffolding is done.</p>
<p>As for the next steps, I would like to draw some text, and react to
user input events. Maybe even port something like <a
href="https://github.com/rxi/microui">microui</a>, which only needs a
few drawing routines, to our application.</p>
<blockquote>
<p>If you liked this article and you want to support me, and can afford
it: <a
href="https://paypal.me/philigaultier?country.x=DE&amp;locale.x=en_US">Donate</a></p>
</blockquote>
<h2 id="addendum-the-full-code">Addendum: the full code</h2>
<p><em>Do not forget to generate <code>wayland-logo.h</code> with the
aforementioned commands!</em></p>
<p>Compile with: <code>cc -std=c99 wayland.c -Ofast</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define _POSIX_C_SOURCE 200112L</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;assert.h&gt;</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;errno.h&gt;</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;inttypes.h&gt;</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stddef.h&gt;</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;string.h&gt;</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/mman.h&gt;</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/socket.h&gt;</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/time.h&gt;</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/un.h&gt;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;wayland-logo.h&quot;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a><span class="pp">#define cstring_len(s) (sizeof(s) - 1)</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#define roundup_4(n) (((n) + 3) &amp; -4)</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_current_id <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_display_object_id <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_registry_event_global <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_shm_pool_event_format <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_buffer_event_release <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_event_ping <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_toplevel_event_configure <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_toplevel_event_close <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_event_configure <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_display_get_registry_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_registry_bind_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_compositor_create_surface_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_pong_opcode <span class="op">=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_ack_configure_opcode <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_shm_create_pool_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_wm_base_get_xdg_surface_opcode <span class="op">=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_shm_pool_create_buffer_opcode <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_surface_attach_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_xdg_surface_get_toplevel_opcode <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_surface_commit_opcode <span class="op">=</span> <span class="dv">6</span><span class="op">;</span></span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint16_t</span> wayland_wl_display_error_event <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_format_xrgb8888 <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> wayland_header_size <span class="op">=</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="dt">uint32_t</span> color_channels <span class="op">=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">enum</span> state_state_t state_state_t<span class="op">;</span></span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> state_state_t <span class="op">{</span></span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>  STATE_NONE<span class="op">,</span></span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>  STATE_SURFACE_ACKED_CONFIGURE<span class="op">,</span></span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>  STATE_SURFACE_ATTACHED<span class="op">,</span></span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a><span class="kw">typedef</span> <span class="kw">struct</span> state_t state_t<span class="op">;</span></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> state_t <span class="op">{</span></span>
<span id="cb17-58"><a href="#cb17-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_registry<span class="op">;</span></span>
<span id="cb17-59"><a href="#cb17-59" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_shm<span class="op">;</span></span>
<span id="cb17-60"><a href="#cb17-60" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_shm_pool<span class="op">;</span></span>
<span id="cb17-61"><a href="#cb17-61" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_buffer<span class="op">;</span></span>
<span id="cb17-62"><a href="#cb17-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_wm_base<span class="op">;</span></span>
<span id="cb17-63"><a href="#cb17-63" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_surface<span class="op">;</span></span>
<span id="cb17-64"><a href="#cb17-64" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_compositor<span class="op">;</span></span>
<span id="cb17-65"><a href="#cb17-65" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> wl_surface<span class="op">;</span></span>
<span id="cb17-66"><a href="#cb17-66" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> xdg_toplevel<span class="op">;</span></span>
<span id="cb17-67"><a href="#cb17-67" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> stride<span class="op">;</span></span>
<span id="cb17-68"><a href="#cb17-68" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> w<span class="op">;</span></span>
<span id="cb17-69"><a href="#cb17-69" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> h<span class="op">;</span></span>
<span id="cb17-70"><a href="#cb17-70" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> shm_pool_size<span class="op">;</span></span>
<span id="cb17-71"><a href="#cb17-71" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> shm_fd<span class="op">;</span></span>
<span id="cb17-72"><a href="#cb17-72" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> <span class="op">*</span>shm_pool_data<span class="op">;</span></span>
<span id="cb17-73"><a href="#cb17-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-74"><a href="#cb17-74" aria-hidden="true" tabindex="-1"></a>  state_state_t state<span class="op">;</span></span>
<span id="cb17-75"><a href="#cb17-75" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb17-76"><a href="#cb17-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-77"><a href="#cb17-77" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> wayland_display_connect<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-78"><a href="#cb17-78" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>xdg_runtime_dir <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;XDG_RUNTIME_DIR&quot;</span><span class="op">);</span></span>
<span id="cb17-79"><a href="#cb17-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>xdg_runtime_dir <span class="op">==</span> NULL<span class="op">)</span></span>
<span id="cb17-80"><a href="#cb17-80" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> EINVAL<span class="op">;</span></span>
<span id="cb17-81"><a href="#cb17-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-82"><a href="#cb17-82" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> xdg_runtime_dir_len <span class="op">=</span> strlen<span class="op">(</span>xdg_runtime_dir<span class="op">);</span></span>
<span id="cb17-83"><a href="#cb17-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-84"><a href="#cb17-84" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> sockaddr_un addr <span class="op">=</span> <span class="op">{.</span>sun_family <span class="op">=</span> AF_UNIX<span class="op">};</span></span>
<span id="cb17-85"><a href="#cb17-85" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>xdg_runtime_dir_len <span class="op">&lt;=</span> cstring_len<span class="op">(</span>addr<span class="op">.</span>sun_path<span class="op">));</span></span>
<span id="cb17-86"><a href="#cb17-86" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> socket_path_len <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-87"><a href="#cb17-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-88"><a href="#cb17-88" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path<span class="op">,</span> xdg_runtime_dir<span class="op">,</span> xdg_runtime_dir_len<span class="op">);</span></span>
<span id="cb17-89"><a href="#cb17-89" aria-hidden="true" tabindex="-1"></a>  socket_path_len <span class="op">+=</span> xdg_runtime_dir_len<span class="op">;</span></span>
<span id="cb17-90"><a href="#cb17-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-91"><a href="#cb17-91" aria-hidden="true" tabindex="-1"></a>  addr<span class="op">.</span>sun_path<span class="op">[</span>socket_path_len<span class="op">++]</span> <span class="op">=</span> <span class="ch">&#39;/&#39;</span><span class="op">;</span></span>
<span id="cb17-92"><a href="#cb17-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-93"><a href="#cb17-93" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> <span class="op">*</span>wayland_display <span class="op">=</span> getenv<span class="op">(</span><span class="st">&quot;WAYLAND_DISPLAY&quot;</span><span class="op">);</span></span>
<span id="cb17-94"><a href="#cb17-94" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>wayland_display <span class="op">==</span> NULL<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-95"><a href="#cb17-95" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wayland_display_default<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wayland-0&quot;</span><span class="op">;</span></span>
<span id="cb17-96"><a href="#cb17-96" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> wayland_display_default_len <span class="op">=</span> cstring_len<span class="op">(</span>wayland_display_default<span class="op">);</span></span>
<span id="cb17-97"><a href="#cb17-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-98"><a href="#cb17-98" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path <span class="op">+</span> socket_path_len<span class="op">,</span> wayland_display_default<span class="op">,</span></span>
<span id="cb17-99"><a href="#cb17-99" aria-hidden="true" tabindex="-1"></a>           wayland_display_default_len<span class="op">);</span></span>
<span id="cb17-100"><a href="#cb17-100" aria-hidden="true" tabindex="-1"></a>    socket_path_len <span class="op">+=</span> wayland_display_default_len<span class="op">;</span></span>
<span id="cb17-101"><a href="#cb17-101" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb17-102"><a href="#cb17-102" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> wayland_display_len <span class="op">=</span> strlen<span class="op">(</span>wayland_display<span class="op">);</span></span>
<span id="cb17-103"><a href="#cb17-103" aria-hidden="true" tabindex="-1"></a>    memcpy<span class="op">(</span>addr<span class="op">.</span>sun_path <span class="op">+</span> socket_path_len<span class="op">,</span> wayland_display<span class="op">,</span></span>
<span id="cb17-104"><a href="#cb17-104" aria-hidden="true" tabindex="-1"></a>           wayland_display_len<span class="op">);</span></span>
<span id="cb17-105"><a href="#cb17-105" aria-hidden="true" tabindex="-1"></a>    socket_path_len <span class="op">+=</span> wayland_display_len<span class="op">;</span></span>
<span id="cb17-106"><a href="#cb17-106" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-107"><a href="#cb17-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-108"><a href="#cb17-108" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> fd <span class="op">=</span> socket<span class="op">(</span>AF_UNIX<span class="op">,</span> SOCK_STREAM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-109"><a href="#cb17-109" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-110"><a href="#cb17-110" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-111"><a href="#cb17-111" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-112"><a href="#cb17-112" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>connect<span class="op">(</span>fd<span class="op">,</span> <span class="op">(</span><span class="kw">struct</span> sockaddr <span class="op">*)&amp;</span>addr<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>addr<span class="op">))</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-113"><a href="#cb17-113" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-114"><a href="#cb17-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-115"><a href="#cb17-115" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> fd<span class="op">;</span></span>
<span id="cb17-116"><a href="#cb17-116" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-117"><a href="#cb17-117" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-118"><a href="#cb17-118" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_u32<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb17-119"><a href="#cb17-119" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">uint32_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-120"><a href="#cb17-120" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb17-121"><a href="#cb17-121" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(((</span><span class="dt">size_t</span><span class="op">)</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-122"><a href="#cb17-122" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-123"><a href="#cb17-123" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(</span><span class="dt">uint32_t</span> <span class="op">*)(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb17-124"><a href="#cb17-124" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">);</span></span>
<span id="cb17-125"><a href="#cb17-125" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-126"><a href="#cb17-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-127"><a href="#cb17-127" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_u16<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb17-128"><a href="#cb17-128" aria-hidden="true" tabindex="-1"></a>                          <span class="dt">uint16_t</span> x<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-129"><a href="#cb17-129" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb17-130"><a href="#cb17-130" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(((</span><span class="dt">size_t</span><span class="op">)</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-131"><a href="#cb17-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-132"><a href="#cb17-132" aria-hidden="true" tabindex="-1"></a>  <span class="op">*(</span><span class="dt">uint16_t</span> <span class="op">*)(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">=</span> x<span class="op">;</span></span>
<span id="cb17-133"><a href="#cb17-133" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>x<span class="op">);</span></span>
<span id="cb17-134"><a href="#cb17-134" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-135"><a href="#cb17-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-136"><a href="#cb17-136" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_write_string<span class="op">(</span><span class="dt">char</span> <span class="op">*</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">uint64_t</span> buf_cap<span class="op">,</span></span>
<span id="cb17-137"><a href="#cb17-137" aria-hidden="true" tabindex="-1"></a>                             <span class="dt">char</span> <span class="op">*</span>src<span class="op">,</span> <span class="dt">uint32_t</span> src_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-138"><a href="#cb17-138" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">+</span> src_len <span class="op">&lt;=</span> buf_cap<span class="op">);</span></span>
<span id="cb17-139"><a href="#cb17-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-140"><a href="#cb17-140" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>buf<span class="op">,</span> buf_size<span class="op">,</span> buf_cap<span class="op">,</span> src_len<span class="op">);</span></span>
<span id="cb17-141"><a href="#cb17-141" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>buf <span class="op">+</span> <span class="op">*</span>buf_size<span class="op">,</span> src<span class="op">,</span> roundup_4<span class="op">(</span>src_len<span class="op">));</span></span>
<span id="cb17-142"><a href="#cb17-142" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">+=</span> roundup_4<span class="op">(</span>src_len<span class="op">);</span></span>
<span id="cb17-143"><a href="#cb17-143" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-144"><a href="#cb17-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-145"><a href="#cb17-145" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> buf_read_u32<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-146"><a href="#cb17-146" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">));</span></span>
<span id="cb17-147"><a href="#cb17-147" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">((</span><span class="dt">size_t</span><span class="op">)*</span>buf <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-148"><a href="#cb17-148" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-149"><a href="#cb17-149" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> res <span class="op">=</span> <span class="op">*(</span><span class="dt">uint32_t</span> <span class="op">*)(*</span>buf<span class="op">);</span></span>
<span id="cb17-150"><a href="#cb17-150" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb17-151"><a href="#cb17-151" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb17-152"><a href="#cb17-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-153"><a href="#cb17-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb17-154"><a href="#cb17-154" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-155"><a href="#cb17-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-156"><a href="#cb17-156" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint16_t</span> buf_read_u16<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-157"><a href="#cb17-157" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint16_t</span><span class="op">));</span></span>
<span id="cb17-158"><a href="#cb17-158" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">((</span><span class="dt">size_t</span><span class="op">)*</span>buf <span class="op">%</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint16_t</span><span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-159"><a href="#cb17-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-160"><a href="#cb17-160" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> res <span class="op">=</span> <span class="op">*(</span><span class="dt">uint16_t</span> <span class="op">*)(*</span>buf<span class="op">);</span></span>
<span id="cb17-161"><a href="#cb17-161" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb17-162"><a href="#cb17-162" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> <span class="kw">sizeof</span><span class="op">(</span>res<span class="op">);</span></span>
<span id="cb17-163"><a href="#cb17-163" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-164"><a href="#cb17-164" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> res<span class="op">;</span></span>
<span id="cb17-165"><a href="#cb17-165" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-166"><a href="#cb17-166" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-167"><a href="#cb17-167" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> buf_read_n<span class="op">(</span><span class="dt">char</span> <span class="op">**</span>buf<span class="op">,</span> <span class="dt">uint64_t</span> <span class="op">*</span>buf_size<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>dst<span class="op">,</span> <span class="dt">uint64_t</span> n<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-168"><a href="#cb17-168" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>buf_size <span class="op">&gt;=</span> n<span class="op">);</span></span>
<span id="cb17-169"><a href="#cb17-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-170"><a href="#cb17-170" aria-hidden="true" tabindex="-1"></a>  memcpy<span class="op">(</span>dst<span class="op">,</span> <span class="op">*</span>buf<span class="op">,</span> n<span class="op">);</span></span>
<span id="cb17-171"><a href="#cb17-171" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-172"><a href="#cb17-172" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf <span class="op">+=</span> n<span class="op">;</span></span>
<span id="cb17-173"><a href="#cb17-173" aria-hidden="true" tabindex="-1"></a>  <span class="op">*</span>buf_size <span class="op">-=</span> n<span class="op">;</span></span>
<span id="cb17-174"><a href="#cb17-174" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-175"><a href="#cb17-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-176"><a href="#cb17-176" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_display_get_registry<span class="op">(</span><span class="dt">int</span> fd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-177"><a href="#cb17-177" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-178"><a href="#cb17-178" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-179"><a href="#cb17-179" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_display_object_id<span class="op">);</span></span>
<span id="cb17-180"><a href="#cb17-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-181"><a href="#cb17-181" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-182"><a href="#cb17-182" aria-hidden="true" tabindex="-1"></a>                wayland_wl_display_get_registry_opcode<span class="op">);</span></span>
<span id="cb17-183"><a href="#cb17-183" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-184"><a href="#cb17-184" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-185"><a href="#cb17-185" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">);</span></span>
<span id="cb17-186"><a href="#cb17-186" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-187"><a href="#cb17-187" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-188"><a href="#cb17-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-189"><a href="#cb17-189" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-190"><a href="#cb17-190" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-191"><a href="#cb17-191" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-192"><a href="#cb17-192" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-193"><a href="#cb17-193" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-194"><a href="#cb17-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-195"><a href="#cb17-195" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_display@%u.get_registry: wl_registry=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-196"><a href="#cb17-196" aria-hidden="true" tabindex="-1"></a>         wayland_display_object_id<span class="op">,</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-197"><a href="#cb17-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-198"><a href="#cb17-198" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-199"><a href="#cb17-199" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-200"><a href="#cb17-200" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-201"><a href="#cb17-201" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_registry_bind<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> <span class="dt">uint32_t</span> registry<span class="op">,</span></span>
<span id="cb17-202"><a href="#cb17-202" aria-hidden="true" tabindex="-1"></a>                                         <span class="dt">uint32_t</span> name<span class="op">,</span> <span class="dt">char</span> <span class="op">*</span>interface<span class="op">,</span></span>
<span id="cb17-203"><a href="#cb17-203" aria-hidden="true" tabindex="-1"></a>                                         <span class="dt">uint32_t</span> interface_len<span class="op">,</span></span>
<span id="cb17-204"><a href="#cb17-204" aria-hidden="true" tabindex="-1"></a>                                         <span class="dt">uint32_t</span> version<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-205"><a href="#cb17-205" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-206"><a href="#cb17-206" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-207"><a href="#cb17-207" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> registry<span class="op">);</span></span>
<span id="cb17-208"><a href="#cb17-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-209"><a href="#cb17-209" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_wl_registry_bind_opcode<span class="op">);</span></span>
<span id="cb17-210"><a href="#cb17-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-211"><a href="#cb17-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-212"><a href="#cb17-212" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>name<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>interface_len<span class="op">)</span> <span class="op">+</span></span>
<span id="cb17-213"><a href="#cb17-213" aria-hidden="true" tabindex="-1"></a>      roundup_4<span class="op">(</span>interface_len<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>version<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">);</span></span>
<span id="cb17-214"><a href="#cb17-214" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-215"><a href="#cb17-215" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-216"><a href="#cb17-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-217"><a href="#cb17-217" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> name<span class="op">);</span></span>
<span id="cb17-218"><a href="#cb17-218" aria-hidden="true" tabindex="-1"></a>  buf_write_string<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> interface<span class="op">,</span> interface_len<span class="op">);</span></span>
<span id="cb17-219"><a href="#cb17-219" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> version<span class="op">);</span></span>
<span id="cb17-220"><a href="#cb17-220" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-221"><a href="#cb17-221" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-222"><a href="#cb17-222" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-223"><a href="#cb17-223" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-224"><a href="#cb17-224" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>msg_size <span class="op">==</span> roundup_4<span class="op">(</span>msg_size<span class="op">));</span></span>
<span id="cb17-225"><a href="#cb17-225" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-226"><a href="#cb17-226" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-227"><a href="#cb17-227" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-228"><a href="#cb17-228" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-229"><a href="#cb17-229" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_registry@%u.bind: name=%u interface=%.*s version=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-230"><a href="#cb17-230" aria-hidden="true" tabindex="-1"></a>         registry<span class="op">,</span> name<span class="op">,</span> interface_len<span class="op">,</span> interface<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb17-231"><a href="#cb17-231" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-232"><a href="#cb17-232" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-233"><a href="#cb17-233" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-234"><a href="#cb17-234" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-235"><a href="#cb17-235" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_compositor_create_surface<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-236"><a href="#cb17-236" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_compositor <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-237"><a href="#cb17-237" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-238"><a href="#cb17-238" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-239"><a href="#cb17-239" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-240"><a href="#cb17-240" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_compositor<span class="op">);</span></span>
<span id="cb17-241"><a href="#cb17-241" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-242"><a href="#cb17-242" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-243"><a href="#cb17-243" aria-hidden="true" tabindex="-1"></a>                wayland_wl_compositor_create_surface_opcode<span class="op">);</span></span>
<span id="cb17-244"><a href="#cb17-244" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-245"><a href="#cb17-245" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-246"><a href="#cb17-246" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">);</span></span>
<span id="cb17-247"><a href="#cb17-247" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-248"><a href="#cb17-248" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-249"><a href="#cb17-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-250"><a href="#cb17-250" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-251"><a href="#cb17-251" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-252"><a href="#cb17-252" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-253"><a href="#cb17-253" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-254"><a href="#cb17-254" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-255"><a href="#cb17-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-256"><a href="#cb17-256" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_compositor@%u.create_surface: wl_surface=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-257"><a href="#cb17-257" aria-hidden="true" tabindex="-1"></a>         state<span class="op">-&gt;</span>wl_compositor<span class="op">,</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-258"><a href="#cb17-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-259"><a href="#cb17-259" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-260"><a href="#cb17-260" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-261"><a href="#cb17-261" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-262"><a href="#cb17-262" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> create_shared_memory_file<span class="op">(</span><span class="dt">uint64_t</span> size<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-263"><a href="#cb17-263" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> name<span class="op">[</span><span class="dv">255</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;/&quot;</span><span class="op">;</span></span>
<span id="cb17-264"><a href="#cb17-264" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">uint64_t</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> cstring_len<span class="op">(</span>name<span class="op">);</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb17-265"><a href="#cb17-265" aria-hidden="true" tabindex="-1"></a>    name<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">((</span><span class="dt">double</span><span class="op">)</span>rand<span class="op">())</span> <span class="op">/</span> <span class="op">(</span><span class="dt">double</span><span class="op">)</span>RAND_MAX <span class="op">*</span> <span class="dv">26</span> <span class="op">+</span> <span class="ch">&#39;a&#39;</span><span class="op">;</span></span>
<span id="cb17-266"><a href="#cb17-266" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-267"><a href="#cb17-267" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-268"><a href="#cb17-268" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> fd <span class="op">=</span> shm_open<span class="op">(</span>name<span class="op">,</span> O_RDWR <span class="op">|</span> O_EXCL <span class="op">|</span> O_CREAT<span class="op">,</span> <span class="bn">0600</span><span class="op">);</span></span>
<span id="cb17-269"><a href="#cb17-269" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fd <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-270"><a href="#cb17-270" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-271"><a href="#cb17-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-272"><a href="#cb17-272" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>shm_unlink<span class="op">(</span>name<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb17-273"><a href="#cb17-273" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-274"><a href="#cb17-274" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>ftruncate<span class="op">(</span>fd<span class="op">,</span> size<span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-275"><a href="#cb17-275" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-276"><a href="#cb17-276" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-277"><a href="#cb17-277" aria-hidden="true" tabindex="-1"></a>  state<span class="op">-&gt;</span>shm_pool_data <span class="op">=</span></span>
<span id="cb17-278"><a href="#cb17-278" aria-hidden="true" tabindex="-1"></a>      mmap<span class="op">(</span>NULL<span class="op">,</span> size<span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">,</span> MAP_SHARED<span class="op">,</span> fd<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-279"><a href="#cb17-279" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>shm_pool_data <span class="op">!=</span> NULL<span class="op">);</span></span>
<span id="cb17-280"><a href="#cb17-280" aria-hidden="true" tabindex="-1"></a>  state<span class="op">-&gt;</span>shm_fd <span class="op">=</span> fd<span class="op">;</span></span>
<span id="cb17-281"><a href="#cb17-281" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-282"><a href="#cb17-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-283"><a href="#cb17-283" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_xdg_wm_base_pong<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">,</span> <span class="dt">uint32_t</span> ping<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-284"><a href="#cb17-284" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>xdg_wm_base <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-285"><a href="#cb17-285" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-286"><a href="#cb17-286" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-287"><a href="#cb17-287" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-288"><a href="#cb17-288" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-289"><a href="#cb17-289" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>xdg_wm_base<span class="op">);</span></span>
<span id="cb17-290"><a href="#cb17-290" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-291"><a href="#cb17-291" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_xdg_wm_base_pong_opcode<span class="op">);</span></span>
<span id="cb17-292"><a href="#cb17-292" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-293"><a href="#cb17-293" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span> wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>ping<span class="op">);</span></span>
<span id="cb17-294"><a href="#cb17-294" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-295"><a href="#cb17-295" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-296"><a href="#cb17-296" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-297"><a href="#cb17-297" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> ping<span class="op">);</span></span>
<span id="cb17-298"><a href="#cb17-298" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-299"><a href="#cb17-299" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-300"><a href="#cb17-300" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-301"><a href="#cb17-301" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-302"><a href="#cb17-302" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; xdg_wm_base@%u.pong: ping=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_wm_base<span class="op">,</span> ping<span class="op">);</span></span>
<span id="cb17-303"><a href="#cb17-303" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-304"><a href="#cb17-304" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-305"><a href="#cb17-305" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_xdg_surface_ack_configure<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">,</span></span>
<span id="cb17-306"><a href="#cb17-306" aria-hidden="true" tabindex="-1"></a>                                              <span class="dt">uint32_t</span> configure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-307"><a href="#cb17-307" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>xdg_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-308"><a href="#cb17-308" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-309"><a href="#cb17-309" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-310"><a href="#cb17-310" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-311"><a href="#cb17-311" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>xdg_surface<span class="op">);</span></span>
<span id="cb17-312"><a href="#cb17-312" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-313"><a href="#cb17-313" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-314"><a href="#cb17-314" aria-hidden="true" tabindex="-1"></a>                wayland_xdg_surface_ack_configure_opcode<span class="op">);</span></span>
<span id="cb17-315"><a href="#cb17-315" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-316"><a href="#cb17-316" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span> wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>configure<span class="op">);</span></span>
<span id="cb17-317"><a href="#cb17-317" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-318"><a href="#cb17-318" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-319"><a href="#cb17-319" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-320"><a href="#cb17-320" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> configure<span class="op">);</span></span>
<span id="cb17-321"><a href="#cb17-321" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-322"><a href="#cb17-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-323"><a href="#cb17-323" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-324"><a href="#cb17-324" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-325"><a href="#cb17-325" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; xdg_surface@%u.ack_configure: configure=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_surface<span class="op">,</span></span>
<span id="cb17-326"><a href="#cb17-326" aria-hidden="true" tabindex="-1"></a>         configure<span class="op">);</span></span>
<span id="cb17-327"><a href="#cb17-327" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-328"><a href="#cb17-328" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-329"><a href="#cb17-329" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_shm_create_pool<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-330"><a href="#cb17-330" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>shm_pool_size <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-331"><a href="#cb17-331" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-332"><a href="#cb17-332" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-333"><a href="#cb17-333" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-334"><a href="#cb17-334" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_shm<span class="op">);</span></span>
<span id="cb17-335"><a href="#cb17-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-336"><a href="#cb17-336" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_wl_shm_create_pool_opcode<span class="op">);</span></span>
<span id="cb17-337"><a href="#cb17-337" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-338"><a href="#cb17-338" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span> wayland_header_size <span class="op">+</span></span>
<span id="cb17-339"><a href="#cb17-339" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">)</span> <span class="op">+</span></span>
<span id="cb17-340"><a href="#cb17-340" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>shm_pool_size<span class="op">);</span></span>
<span id="cb17-341"><a href="#cb17-341" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-342"><a href="#cb17-342" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-343"><a href="#cb17-343" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-344"><a href="#cb17-344" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-345"><a href="#cb17-345" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-346"><a href="#cb17-346" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-347"><a href="#cb17-347" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-348"><a href="#cb17-348" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>shm_pool_size<span class="op">);</span></span>
<span id="cb17-349"><a href="#cb17-349" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-350"><a href="#cb17-350" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_size<span class="op">)</span> <span class="op">==</span> msg_size<span class="op">);</span></span>
<span id="cb17-351"><a href="#cb17-351" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-352"><a href="#cb17-352" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Send the file descriptor as ancillary data.</span></span>
<span id="cb17-353"><a href="#cb17-353" aria-hidden="true" tabindex="-1"></a>  <span class="co">// UNIX/Macros monstrosities ahead.</span></span>
<span id="cb17-354"><a href="#cb17-354" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> buf<span class="op">[</span>CMSG_SPACE<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>shm_fd<span class="op">))]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-355"><a href="#cb17-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-356"><a href="#cb17-356" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> iovec io <span class="op">=</span> <span class="op">{.</span>iov_base <span class="op">=</span> msg<span class="op">,</span> <span class="op">.</span>iov_len <span class="op">=</span> msg_size<span class="op">};</span></span>
<span id="cb17-357"><a href="#cb17-357" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> msghdr socket_msg <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-358"><a href="#cb17-358" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>msg_iov <span class="op">=</span> <span class="op">&amp;</span>io<span class="op">,</span></span>
<span id="cb17-359"><a href="#cb17-359" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>msg_iovlen <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb17-360"><a href="#cb17-360" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>msg_control <span class="op">=</span> buf<span class="op">,</span></span>
<span id="cb17-361"><a href="#cb17-361" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>msg_controllen <span class="op">=</span> <span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">),</span></span>
<span id="cb17-362"><a href="#cb17-362" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb17-363"><a href="#cb17-363" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-364"><a href="#cb17-364" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> cmsghdr <span class="op">*</span>cmsg <span class="op">=</span> CMSG_FIRSTHDR<span class="op">(&amp;</span>socket_msg<span class="op">);</span></span>
<span id="cb17-365"><a href="#cb17-365" aria-hidden="true" tabindex="-1"></a>  cmsg<span class="op">-&gt;</span>cmsg_level <span class="op">=</span> SOL_SOCKET<span class="op">;</span></span>
<span id="cb17-366"><a href="#cb17-366" aria-hidden="true" tabindex="-1"></a>  cmsg<span class="op">-&gt;</span>cmsg_type <span class="op">=</span> SCM_RIGHTS<span class="op">;</span></span>
<span id="cb17-367"><a href="#cb17-367" aria-hidden="true" tabindex="-1"></a>  cmsg<span class="op">-&gt;</span>cmsg_len <span class="op">=</span> CMSG_LEN<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>shm_fd<span class="op">));</span></span>
<span id="cb17-368"><a href="#cb17-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-369"><a href="#cb17-369" aria-hidden="true" tabindex="-1"></a>  <span class="op">*((</span><span class="dt">int</span> <span class="op">*)</span>CMSG_DATA<span class="op">(</span>cmsg<span class="op">))</span> <span class="op">=</span> state<span class="op">-&gt;</span>shm_fd<span class="op">;</span></span>
<span id="cb17-370"><a href="#cb17-370" aria-hidden="true" tabindex="-1"></a>  socket_msg<span class="op">.</span>msg_controllen <span class="op">=</span> CMSG_SPACE<span class="op">(</span><span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>shm_fd<span class="op">));</span></span>
<span id="cb17-371"><a href="#cb17-371" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-372"><a href="#cb17-372" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>sendmsg<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>socket_msg<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-373"><a href="#cb17-373" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-374"><a href="#cb17-374" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-375"><a href="#cb17-375" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_shm@%u.create_pool: wl_shm_pool=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>wl_shm<span class="op">,</span></span>
<span id="cb17-376"><a href="#cb17-376" aria-hidden="true" tabindex="-1"></a>         wayland_current_id<span class="op">);</span></span>
<span id="cb17-377"><a href="#cb17-377" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-378"><a href="#cb17-378" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-379"><a href="#cb17-379" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-380"><a href="#cb17-380" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-381"><a href="#cb17-381" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_xdg_wm_base_get_xdg_surface<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-382"><a href="#cb17-382" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>xdg_wm_base <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-383"><a href="#cb17-383" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-384"><a href="#cb17-384" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-385"><a href="#cb17-385" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-386"><a href="#cb17-386" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-387"><a href="#cb17-387" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>xdg_wm_base<span class="op">);</span></span>
<span id="cb17-388"><a href="#cb17-388" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-389"><a href="#cb17-389" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-390"><a href="#cb17-390" aria-hidden="true" tabindex="-1"></a>                wayland_xdg_wm_base_get_xdg_surface_opcode<span class="op">);</span></span>
<span id="cb17-391"><a href="#cb17-391" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-392"><a href="#cb17-392" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span> wayland_header_size <span class="op">+</span></span>
<span id="cb17-393"><a href="#cb17-393" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">)</span> <span class="op">+</span></span>
<span id="cb17-394"><a href="#cb17-394" aria-hidden="true" tabindex="-1"></a>                                <span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-395"><a href="#cb17-395" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-396"><a href="#cb17-396" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-397"><a href="#cb17-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-398"><a href="#cb17-398" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-399"><a href="#cb17-399" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-400"><a href="#cb17-400" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-401"><a href="#cb17-401" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-402"><a href="#cb17-402" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-403"><a href="#cb17-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-404"><a href="#cb17-404" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-405"><a href="#cb17-405" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-406"><a href="#cb17-406" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; xdg_wm_base@%u.get_xdg_surface: xdg_surface=%u wl_surface=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-407"><a href="#cb17-407" aria-hidden="true" tabindex="-1"></a>         state<span class="op">-&gt;</span>xdg_wm_base<span class="op">,</span> wayland_current_id<span class="op">,</span> state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-408"><a href="#cb17-408" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-409"><a href="#cb17-409" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-410"><a href="#cb17-410" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-411"><a href="#cb17-411" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-412"><a href="#cb17-412" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_wl_shm_pool_create_buffer<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-413"><a href="#cb17-413" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_shm_pool <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-414"><a href="#cb17-414" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-415"><a href="#cb17-415" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-416"><a href="#cb17-416" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-417"><a href="#cb17-417" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_shm_pool<span class="op">);</span></span>
<span id="cb17-418"><a href="#cb17-418" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-419"><a href="#cb17-419" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-420"><a href="#cb17-420" aria-hidden="true" tabindex="-1"></a>                wayland_wl_shm_pool_create_buffer_opcode<span class="op">);</span></span>
<span id="cb17-421"><a href="#cb17-421" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-422"><a href="#cb17-422" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-423"><a href="#cb17-423" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)</span> <span class="op">*</span> <span class="dv">5</span><span class="op">;</span></span>
<span id="cb17-424"><a href="#cb17-424" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-425"><a href="#cb17-425" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-426"><a href="#cb17-426" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-427"><a href="#cb17-427" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-428"><a href="#cb17-428" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-429"><a href="#cb17-429" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-430"><a href="#cb17-430" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> offset <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-431"><a href="#cb17-431" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> offset<span class="op">);</span></span>
<span id="cb17-432"><a href="#cb17-432" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-433"><a href="#cb17-433" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>w<span class="op">);</span></span>
<span id="cb17-434"><a href="#cb17-434" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-435"><a href="#cb17-435" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>h<span class="op">);</span></span>
<span id="cb17-436"><a href="#cb17-436" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-437"><a href="#cb17-437" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>stride<span class="op">);</span></span>
<span id="cb17-438"><a href="#cb17-438" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-439"><a href="#cb17-439" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> format <span class="op">=</span> wayland_format_xrgb8888<span class="op">;</span></span>
<span id="cb17-440"><a href="#cb17-440" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> format<span class="op">);</span></span>
<span id="cb17-441"><a href="#cb17-441" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-442"><a href="#cb17-442" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-443"><a href="#cb17-443" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-444"><a href="#cb17-444" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-445"><a href="#cb17-445" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_shm_pool@%u.create_buffer: wl_buffer=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>wl_shm_pool<span class="op">,</span></span>
<span id="cb17-446"><a href="#cb17-446" aria-hidden="true" tabindex="-1"></a>         wayland_current_id<span class="op">);</span></span>
<span id="cb17-447"><a href="#cb17-447" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-448"><a href="#cb17-448" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-449"><a href="#cb17-449" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-450"><a href="#cb17-450" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-451"><a href="#cb17-451" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_wl_surface_attach<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-452"><a href="#cb17-452" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-453"><a href="#cb17-453" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_buffer <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-454"><a href="#cb17-454" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-455"><a href="#cb17-455" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-456"><a href="#cb17-456" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-457"><a href="#cb17-457" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-458"><a href="#cb17-458" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-459"><a href="#cb17-459" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_wl_surface_attach_opcode<span class="op">);</span></span>
<span id="cb17-460"><a href="#cb17-460" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-461"><a href="#cb17-461" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-462"><a href="#cb17-462" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>state<span class="op">-&gt;</span>wl_buffer<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">uint32_t</span><span class="op">)</span> <span class="op">*</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb17-463"><a href="#cb17-463" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-464"><a href="#cb17-464" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-465"><a href="#cb17-465" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-466"><a href="#cb17-466" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_buffer<span class="op">);</span></span>
<span id="cb17-467"><a href="#cb17-467" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-468"><a href="#cb17-468" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> x <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> y <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-469"><a href="#cb17-469" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> x<span class="op">);</span></span>
<span id="cb17-470"><a href="#cb17-470" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> y<span class="op">);</span></span>
<span id="cb17-471"><a href="#cb17-471" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-472"><a href="#cb17-472" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-473"><a href="#cb17-473" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-474"><a href="#cb17-474" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-475"><a href="#cb17-475" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_surface@%u.attach: wl_buffer=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>wl_surface<span class="op">,</span></span>
<span id="cb17-476"><a href="#cb17-476" aria-hidden="true" tabindex="-1"></a>         state<span class="op">-&gt;</span>wl_buffer<span class="op">);</span></span>
<span id="cb17-477"><a href="#cb17-477" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-478"><a href="#cb17-478" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-479"><a href="#cb17-479" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">uint32_t</span> wayland_xdg_surface_get_toplevel<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-480"><a href="#cb17-480" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>xdg_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-481"><a href="#cb17-481" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-482"><a href="#cb17-482" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-483"><a href="#cb17-483" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-484"><a href="#cb17-484" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>xdg_surface<span class="op">);</span></span>
<span id="cb17-485"><a href="#cb17-485" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-486"><a href="#cb17-486" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span></span>
<span id="cb17-487"><a href="#cb17-487" aria-hidden="true" tabindex="-1"></a>                wayland_xdg_surface_get_toplevel_opcode<span class="op">);</span></span>
<span id="cb17-488"><a href="#cb17-488" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-489"><a href="#cb17-489" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span></span>
<span id="cb17-490"><a href="#cb17-490" aria-hidden="true" tabindex="-1"></a>      wayland_header_size <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>wayland_current_id<span class="op">);</span></span>
<span id="cb17-491"><a href="#cb17-491" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-492"><a href="#cb17-492" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-493"><a href="#cb17-493" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-494"><a href="#cb17-494" aria-hidden="true" tabindex="-1"></a>  wayland_current_id<span class="op">++;</span></span>
<span id="cb17-495"><a href="#cb17-495" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-496"><a href="#cb17-496" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-497"><a href="#cb17-497" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-498"><a href="#cb17-498" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-499"><a href="#cb17-499" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-500"><a href="#cb17-500" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; xdg_surface@%u.get_toplevel: xdg_toplevel=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-501"><a href="#cb17-501" aria-hidden="true" tabindex="-1"></a>         state<span class="op">-&gt;</span>xdg_surface<span class="op">,</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-502"><a href="#cb17-502" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-503"><a href="#cb17-503" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> wayland_current_id<span class="op">;</span></span>
<span id="cb17-504"><a href="#cb17-504" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-505"><a href="#cb17-505" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-506"><a href="#cb17-506" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_wl_surface_commit<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-507"><a href="#cb17-507" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>state<span class="op">-&gt;</span>wl_surface <span class="op">&gt;</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-508"><a href="#cb17-508" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-509"><a href="#cb17-509" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint64_t</span> msg_size <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb17-510"><a href="#cb17-510" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span> msg<span class="op">[</span><span class="dv">128</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-511"><a href="#cb17-511" aria-hidden="true" tabindex="-1"></a>  buf_write_u32<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-512"><a href="#cb17-512" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-513"><a href="#cb17-513" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> wayland_wl_surface_commit_opcode<span class="op">);</span></span>
<span id="cb17-514"><a href="#cb17-514" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-515"><a href="#cb17-515" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> msg_announced_size <span class="op">=</span> wayland_header_size<span class="op">;</span></span>
<span id="cb17-516"><a href="#cb17-516" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>msg_announced_size<span class="op">)</span> <span class="op">==</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-517"><a href="#cb17-517" aria-hidden="true" tabindex="-1"></a>  buf_write_u16<span class="op">(</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_size<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>msg<span class="op">),</span> msg_announced_size<span class="op">);</span></span>
<span id="cb17-518"><a href="#cb17-518" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-519"><a href="#cb17-519" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">((</span><span class="dt">int64_t</span><span class="op">)</span>msg_size <span class="op">!=</span> send<span class="op">(</span>fd<span class="op">,</span> msg<span class="op">,</span> msg_size<span class="op">,</span> <span class="dv">0</span><span class="op">))</span></span>
<span id="cb17-520"><a href="#cb17-520" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-521"><a href="#cb17-521" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-522"><a href="#cb17-522" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;-&gt; wl_surface@%u.commit: </span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>wl_surface<span class="op">);</span></span>
<span id="cb17-523"><a href="#cb17-523" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-524"><a href="#cb17-524" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-525"><a href="#cb17-525" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> wayland_handle_message<span class="op">(</span><span class="dt">int</span> fd<span class="op">,</span> state_t <span class="op">*</span>state<span class="op">,</span> <span class="dt">char</span> <span class="op">**</span>msg<span class="op">,</span></span>
<span id="cb17-526"><a href="#cb17-526" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">uint64_t</span> <span class="op">*</span>msg_len<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-527"><a href="#cb17-527" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(*</span>msg_len <span class="op">&gt;=</span> <span class="dv">8</span><span class="op">);</span></span>
<span id="cb17-528"><a href="#cb17-528" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-529"><a href="#cb17-529" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> object_id <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-530"><a href="#cb17-530" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>object_id <span class="op">&lt;=</span> wayland_current_id<span class="op">);</span></span>
<span id="cb17-531"><a href="#cb17-531" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-532"><a href="#cb17-532" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> opcode <span class="op">=</span> buf_read_u16<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-533"><a href="#cb17-533" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-534"><a href="#cb17-534" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint16_t</span> announced_size <span class="op">=</span> buf_read_u16<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-535"><a href="#cb17-535" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>roundup_4<span class="op">(</span>announced_size<span class="op">)</span> <span class="op">&lt;=</span> announced_size<span class="op">);</span></span>
<span id="cb17-536"><a href="#cb17-536" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-537"><a href="#cb17-537" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint32_t</span> header_size <span class="op">=</span></span>
<span id="cb17-538"><a href="#cb17-538" aria-hidden="true" tabindex="-1"></a>      <span class="kw">sizeof</span><span class="op">(</span>object_id<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>opcode<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>announced_size<span class="op">);</span></span>
<span id="cb17-539"><a href="#cb17-539" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>announced_size <span class="op">&lt;=</span> header_size <span class="op">+</span> <span class="op">*</span>msg_len<span class="op">);</span></span>
<span id="cb17-540"><a href="#cb17-540" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-541"><a href="#cb17-541" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>wl_registry <span class="op">&amp;&amp;</span></span>
<span id="cb17-542"><a href="#cb17-542" aria-hidden="true" tabindex="-1"></a>      opcode <span class="op">==</span> wayland_wl_registry_event_global<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-543"><a href="#cb17-543" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> name <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-544"><a href="#cb17-544" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-545"><a href="#cb17-545" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> interface_len <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-546"><a href="#cb17-546" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> padded_interface_len <span class="op">=</span> roundup_4<span class="op">(</span>interface_len<span class="op">);</span></span>
<span id="cb17-547"><a href="#cb17-547" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-548"><a href="#cb17-548" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> interface<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-549"><a href="#cb17-549" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>padded_interface_len <span class="op">&lt;=</span> cstring_len<span class="op">(</span>interface<span class="op">));</span></span>
<span id="cb17-550"><a href="#cb17-550" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-551"><a href="#cb17-551" aria-hidden="true" tabindex="-1"></a>    buf_read_n<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">,</span> interface<span class="op">,</span> padded_interface_len<span class="op">);</span></span>
<span id="cb17-552"><a href="#cb17-552" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>interface<span class="op">[</span>interface_len<span class="op">]</span> <span class="op">==</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-553"><a href="#cb17-553" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-554"><a href="#cb17-554" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> version <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-555"><a href="#cb17-555" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-556"><a href="#cb17-556" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- wl_registry@%u.global: name=%u interface=%.*s version=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-557"><a href="#cb17-557" aria-hidden="true" tabindex="-1"></a>           state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface_len<span class="op">,</span> interface<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb17-558"><a href="#cb17-558" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-559"><a href="#cb17-559" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>announced_size <span class="op">==</span> <span class="kw">sizeof</span><span class="op">(</span>object_id<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>announced_size<span class="op">)</span> <span class="op">+</span></span>
<span id="cb17-560"><a href="#cb17-560" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>opcode<span class="op">)</span> <span class="op">+</span> <span class="kw">sizeof</span><span class="op">(</span>name<span class="op">)</span> <span class="op">+</span></span>
<span id="cb17-561"><a href="#cb17-561" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>interface_len<span class="op">)</span> <span class="op">+</span> padded_interface_len <span class="op">+</span></span>
<span id="cb17-562"><a href="#cb17-562" aria-hidden="true" tabindex="-1"></a>                                 <span class="kw">sizeof</span><span class="op">(</span>version<span class="op">));</span></span>
<span id="cb17-563"><a href="#cb17-563" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-564"><a href="#cb17-564" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wl_shm_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wl_shm&quot;</span><span class="op">;</span></span>
<span id="cb17-565"><a href="#cb17-565" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>wl_shm_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-566"><a href="#cb17-566" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>wl_shm <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb17-567"><a href="#cb17-567" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb17-568"><a href="#cb17-568" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-569"><a href="#cb17-569" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-570"><a href="#cb17-570" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> xdg_wm_base_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;xdg_wm_base&quot;</span><span class="op">;</span></span>
<span id="cb17-571"><a href="#cb17-571" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>xdg_wm_base_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-572"><a href="#cb17-572" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>xdg_wm_base <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb17-573"><a href="#cb17-573" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb17-574"><a href="#cb17-574" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-575"><a href="#cb17-575" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-576"><a href="#cb17-576" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> wl_compositor_interface<span class="op">[]</span> <span class="op">=</span> <span class="st">&quot;wl_compositor&quot;</span><span class="op">;</span></span>
<span id="cb17-577"><a href="#cb17-577" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>strcmp<span class="op">(</span>wl_compositor_interface<span class="op">,</span> interface<span class="op">)</span> <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-578"><a href="#cb17-578" aria-hidden="true" tabindex="-1"></a>      state<span class="op">-&gt;</span>wl_compositor <span class="op">=</span> wayland_wl_registry_bind<span class="op">(</span></span>
<span id="cb17-579"><a href="#cb17-579" aria-hidden="true" tabindex="-1"></a>          fd<span class="op">,</span> state<span class="op">-&gt;</span>wl_registry<span class="op">,</span> name<span class="op">,</span> interface<span class="op">,</span> interface_len<span class="op">,</span> version<span class="op">);</span></span>
<span id="cb17-580"><a href="#cb17-580" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-581"><a href="#cb17-581" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-582"><a href="#cb17-582" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-583"><a href="#cb17-583" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> wayland_display_object_id <span class="op">&amp;&amp;</span></span>
<span id="cb17-584"><a href="#cb17-584" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_wl_display_error_event<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-585"><a href="#cb17-585" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> target_object_id <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-586"><a href="#cb17-586" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> code <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-587"><a href="#cb17-587" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> error<span class="op">[</span><span class="dv">512</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-588"><a href="#cb17-588" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> error_len <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-589"><a href="#cb17-589" aria-hidden="true" tabindex="-1"></a>    buf_read_n<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">,</span> error<span class="op">,</span> roundup_4<span class="op">(</span>error_len<span class="op">));</span></span>
<span id="cb17-590"><a href="#cb17-590" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-591"><a href="#cb17-591" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;fatal error: target_object_id=%u code=%u error=%s</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-592"><a href="#cb17-592" aria-hidden="true" tabindex="-1"></a>            target_object_id<span class="op">,</span> code<span class="op">,</span> error<span class="op">);</span></span>
<span id="cb17-593"><a href="#cb17-593" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span>EINVAL<span class="op">);</span></span>
<span id="cb17-594"><a href="#cb17-594" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>wl_shm <span class="op">&amp;&amp;</span></span>
<span id="cb17-595"><a href="#cb17-595" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_shm_pool_event_format<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-596"><a href="#cb17-596" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-597"><a href="#cb17-597" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> format <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-598"><a href="#cb17-598" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- wl_shm: format=%#x</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> format<span class="op">);</span></span>
<span id="cb17-599"><a href="#cb17-599" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-600"><a href="#cb17-600" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>wl_buffer <span class="op">&amp;&amp;</span></span>
<span id="cb17-601"><a href="#cb17-601" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_wl_buffer_event_release<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-602"><a href="#cb17-602" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No-op, for now.</span></span>
<span id="cb17-603"><a href="#cb17-603" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-604"><a href="#cb17-604" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_wl_buffer@%u.release</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>wl_buffer<span class="op">);</span></span>
<span id="cb17-605"><a href="#cb17-605" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-606"><a href="#cb17-606" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_wm_base <span class="op">&amp;&amp;</span></span>
<span id="cb17-607"><a href="#cb17-607" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_wm_base_event_ping<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-608"><a href="#cb17-608" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> ping <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-609"><a href="#cb17-609" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_wm_base@%u.ping: ping=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_wm_base<span class="op">,</span> ping<span class="op">);</span></span>
<span id="cb17-610"><a href="#cb17-610" aria-hidden="true" tabindex="-1"></a>    wayland_xdg_wm_base_pong<span class="op">(</span>fd<span class="op">,</span> state<span class="op">,</span> ping<span class="op">);</span></span>
<span id="cb17-611"><a href="#cb17-611" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-612"><a href="#cb17-612" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-613"><a href="#cb17-613" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_toplevel <span class="op">&amp;&amp;</span></span>
<span id="cb17-614"><a href="#cb17-614" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_toplevel_event_configure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-615"><a href="#cb17-615" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> w <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-616"><a href="#cb17-616" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> h <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-617"><a href="#cb17-617" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> len <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-618"><a href="#cb17-618" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> buf<span class="op">[</span><span class="dv">256</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-619"><a href="#cb17-619" aria-hidden="true" tabindex="-1"></a>    assert<span class="op">(</span>len <span class="op">&lt;=</span> <span class="kw">sizeof</span><span class="op">(</span>buf<span class="op">));</span></span>
<span id="cb17-620"><a href="#cb17-620" aria-hidden="true" tabindex="-1"></a>    buf_read_n<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">,</span> buf<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb17-621"><a href="#cb17-621" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-622"><a href="#cb17-622" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_toplevel@%u.configure: w=%u h=%u states[%u]</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb17-623"><a href="#cb17-623" aria-hidden="true" tabindex="-1"></a>           state<span class="op">-&gt;</span>xdg_toplevel<span class="op">,</span> w<span class="op">,</span> h<span class="op">,</span> len<span class="op">);</span></span>
<span id="cb17-624"><a href="#cb17-624" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-625"><a href="#cb17-625" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-626"><a href="#cb17-626" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_surface <span class="op">&amp;&amp;</span></span>
<span id="cb17-627"><a href="#cb17-627" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_surface_event_configure<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-628"><a href="#cb17-628" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint32_t</span> configure <span class="op">=</span> buf_read_u32<span class="op">(</span>msg<span class="op">,</span> msg_len<span class="op">);</span></span>
<span id="cb17-629"><a href="#cb17-629" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_surface@%u.configure: configure=%u</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_surface<span class="op">,</span></span>
<span id="cb17-630"><a href="#cb17-630" aria-hidden="true" tabindex="-1"></a>           configure<span class="op">);</span></span>
<span id="cb17-631"><a href="#cb17-631" aria-hidden="true" tabindex="-1"></a>    wayland_xdg_surface_ack_configure<span class="op">(</span>fd<span class="op">,</span> state<span class="op">,</span> configure<span class="op">);</span></span>
<span id="cb17-632"><a href="#cb17-632" aria-hidden="true" tabindex="-1"></a>    state<span class="op">-&gt;</span>state <span class="op">=</span> STATE_SURFACE_ACKED_CONFIGURE<span class="op">;</span></span>
<span id="cb17-633"><a href="#cb17-633" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-634"><a href="#cb17-634" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span><span class="op">;</span></span>
<span id="cb17-635"><a href="#cb17-635" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>object_id <span class="op">==</span> state<span class="op">-&gt;</span>xdg_toplevel <span class="op">&amp;&amp;</span></span>
<span id="cb17-636"><a href="#cb17-636" aria-hidden="true" tabindex="-1"></a>             opcode <span class="op">==</span> wayland_xdg_toplevel_event_close<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-637"><a href="#cb17-637" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;&lt;- xdg_toplevel@%u.close</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>xdg_toplevel<span class="op">);</span></span>
<span id="cb17-638"><a href="#cb17-638" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-639"><a href="#cb17-639" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-640"><a href="#cb17-640" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-641"><a href="#cb17-641" aria-hidden="true" tabindex="-1"></a>  fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;object_id=%u opcode=%u msg_len=%lu</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> object_id<span class="op">,</span> opcode<span class="op">,</span></span>
<span id="cb17-642"><a href="#cb17-642" aria-hidden="true" tabindex="-1"></a>          <span class="op">*</span>msg_len<span class="op">);</span></span>
<span id="cb17-643"><a href="#cb17-643" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span><span class="dv">0</span> <span class="op">&amp;&amp;</span> <span class="st">&quot;todo&quot;</span><span class="op">);</span></span>
<span id="cb17-644"><a href="#cb17-644" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb17-645"><a href="#cb17-645" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-646"><a href="#cb17-646" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb17-647"><a href="#cb17-647" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> timeval tv <span class="op">=</span> <span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb17-648"><a href="#cb17-648" aria-hidden="true" tabindex="-1"></a>  assert<span class="op">(</span>gettimeofday<span class="op">(&amp;</span>tv<span class="op">,</span> NULL<span class="op">)</span> <span class="op">!=</span> <span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb17-649"><a href="#cb17-649" aria-hidden="true" tabindex="-1"></a>  srand<span class="op">(</span>tv<span class="op">.</span>tv_sec <span class="op">*</span> <span class="dv">1000</span> <span class="op">*</span> <span class="dv">1000</span> <span class="op">+</span> tv<span class="op">.</span>tv_usec<span class="op">);</span></span>
<span id="cb17-650"><a href="#cb17-650" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-651"><a href="#cb17-651" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> fd <span class="op">=</span> wayland_display_connect<span class="op">();</span></span>
<span id="cb17-652"><a href="#cb17-652" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-653"><a href="#cb17-653" aria-hidden="true" tabindex="-1"></a>  state_t state <span class="op">=</span> <span class="op">{</span></span>
<span id="cb17-654"><a href="#cb17-654" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>wl_registry <span class="op">=</span> wayland_wl_display_get_registry<span class="op">(</span>fd<span class="op">),</span></span>
<span id="cb17-655"><a href="#cb17-655" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>w <span class="op">=</span> <span class="dv">117</span><span class="op">,</span></span>
<span id="cb17-656"><a href="#cb17-656" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>h <span class="op">=</span> <span class="dv">150</span><span class="op">,</span></span>
<span id="cb17-657"><a href="#cb17-657" aria-hidden="true" tabindex="-1"></a>      <span class="op">.</span>stride <span class="op">=</span> <span class="dv">117</span> <span class="op">*</span> color_channels<span class="op">,</span></span>
<span id="cb17-658"><a href="#cb17-658" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb17-659"><a href="#cb17-659" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-660"><a href="#cb17-660" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Single buffering.</span></span>
<span id="cb17-661"><a href="#cb17-661" aria-hidden="true" tabindex="-1"></a>  state<span class="op">.</span>shm_pool_size <span class="op">=</span> state<span class="op">.</span>h <span class="op">*</span> state<span class="op">.</span>stride<span class="op">;</span></span>
<span id="cb17-662"><a href="#cb17-662" aria-hidden="true" tabindex="-1"></a>  create_shared_memory_file<span class="op">(</span>state<span class="op">.</span>shm_pool_size<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-663"><a href="#cb17-663" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-664"><a href="#cb17-664" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-665"><a href="#cb17-665" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> read_buf<span class="op">[</span><span class="dv">4096</span><span class="op">]</span> <span class="op">=</span> <span class="st">&quot;&quot;</span><span class="op">;</span></span>
<span id="cb17-666"><a href="#cb17-666" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int64_t</span> read_bytes <span class="op">=</span> recv<span class="op">(</span>fd<span class="op">,</span> read_buf<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span>read_buf<span class="op">),</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-667"><a href="#cb17-667" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>read_bytes <span class="op">==</span> <span class="op">-</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb17-668"><a href="#cb17-668" aria-hidden="true" tabindex="-1"></a>      exit<span class="op">(</span>errno<span class="op">);</span></span>
<span id="cb17-669"><a href="#cb17-669" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-670"><a href="#cb17-670" aria-hidden="true" tabindex="-1"></a>    <span class="dt">char</span> <span class="op">*</span>msg <span class="op">=</span> read_buf<span class="op">;</span></span>
<span id="cb17-671"><a href="#cb17-671" aria-hidden="true" tabindex="-1"></a>    <span class="dt">uint64_t</span> msg_len <span class="op">=</span> <span class="op">(</span><span class="dt">uint64_t</span><span class="op">)</span>read_bytes<span class="op">;</span></span>
<span id="cb17-672"><a href="#cb17-672" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-673"><a href="#cb17-673" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> <span class="op">(</span>msg_len <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-674"><a href="#cb17-674" aria-hidden="true" tabindex="-1"></a>      wayland_handle_message<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>msg<span class="op">,</span> <span class="op">&amp;</span>msg_len<span class="op">);</span></span>
<span id="cb17-675"><a href="#cb17-675" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-676"><a href="#cb17-676" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_compositor <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> state<span class="op">.</span>wl_shm <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb17-677"><a href="#cb17-677" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>xdg_wm_base <span class="op">!=</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span></span>
<span id="cb17-678"><a href="#cb17-678" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_surface <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span> <span class="co">// Bind phase complete, need to create surface.</span></span>
<span id="cb17-679"><a href="#cb17-679" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>state <span class="op">==</span> STATE_NONE<span class="op">);</span></span>
<span id="cb17-680"><a href="#cb17-680" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-681"><a href="#cb17-681" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>wl_surface <span class="op">=</span> wayland_wl_compositor_create_surface<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-682"><a href="#cb17-682" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>xdg_surface <span class="op">=</span> wayland_xdg_wm_base_get_xdg_surface<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-683"><a href="#cb17-683" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>xdg_toplevel <span class="op">=</span> wayland_xdg_surface_get_toplevel<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-684"><a href="#cb17-684" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_commit<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-685"><a href="#cb17-685" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-686"><a href="#cb17-686" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-687"><a href="#cb17-687" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>state <span class="op">==</span> STATE_SURFACE_ACKED_CONFIGURE<span class="op">)</span> <span class="op">{</span></span>
<span id="cb17-688"><a href="#cb17-688" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Render a frame.</span></span>
<span id="cb17-689"><a href="#cb17-689" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>wl_surface <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-690"><a href="#cb17-690" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>xdg_surface <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-691"><a href="#cb17-691" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>xdg_toplevel <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-692"><a href="#cb17-692" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-693"><a href="#cb17-693" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_shm_pool <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-694"><a href="#cb17-694" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_shm_pool <span class="op">=</span> wayland_wl_shm_create_pool<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-695"><a href="#cb17-695" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>state<span class="op">.</span>wl_buffer <span class="op">==</span> <span class="dv">0</span><span class="op">)</span></span>
<span id="cb17-696"><a href="#cb17-696" aria-hidden="true" tabindex="-1"></a>        state<span class="op">.</span>wl_buffer <span class="op">=</span> wayland_wl_shm_pool_create_buffer<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-697"><a href="#cb17-697" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-698"><a href="#cb17-698" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>shm_pool_data <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-699"><a href="#cb17-699" aria-hidden="true" tabindex="-1"></a>      assert<span class="op">(</span>state<span class="op">.</span>shm_pool_size <span class="op">!=</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb17-700"><a href="#cb17-700" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-701"><a href="#cb17-701" aria-hidden="true" tabindex="-1"></a>      <span class="dt">uint32_t</span> <span class="op">*</span>pixels <span class="op">=</span> <span class="op">(</span><span class="dt">uint32_t</span> <span class="op">*)</span>state<span class="op">.</span>shm_pool_data<span class="op">;</span></span>
<span id="cb17-702"><a href="#cb17-702" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">uint32_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> state<span class="op">.</span>w <span class="op">*</span> state<span class="op">.</span>h<span class="op">;</span> i<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb17-703"><a href="#cb17-703" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> r <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">0</span><span class="op">];</span></span>
<span id="cb17-704"><a href="#cb17-704" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> g <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">1</span><span class="op">];</span></span>
<span id="cb17-705"><a href="#cb17-705" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint8_t</span> b <span class="op">=</span> wayland_logo<span class="op">[</span>i <span class="op">*</span> <span class="dv">3</span> <span class="op">+</span> <span class="dv">2</span><span class="op">];</span></span>
<span id="cb17-706"><a href="#cb17-706" aria-hidden="true" tabindex="-1"></a>        pixels<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> <span class="op">(</span>r <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">|</span> <span class="op">(</span>g <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">|</span> b<span class="op">;</span></span>
<span id="cb17-707"><a href="#cb17-707" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb17-708"><a href="#cb17-708" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_attach<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-709"><a href="#cb17-709" aria-hidden="true" tabindex="-1"></a>      wayland_wl_surface_commit<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">);</span></span>
<span id="cb17-710"><a href="#cb17-710" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-711"><a href="#cb17-711" aria-hidden="true" tabindex="-1"></a>      state<span class="op">.</span>state <span class="op">=</span> STATE_SURFACE_ATTACHED<span class="op">;</span></span>
<span id="cb17-712"><a href="#cb17-712" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb17-713"><a href="#cb17-713" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb17-714"><a href="#cb17-714" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>

<blockquote id="donate">
  <p>If you liked this article and you want to support me, and can afford it: <a href="https://paypal.me/philigaultier?country.x=DE&locale.x=en_US">Donate</a></p>
</blockquote>

</div>
</body>
</html>
